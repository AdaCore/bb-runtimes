Arm Morello Runtimes
====================

GNAT provides the following runtimes for the Arm Morello Development Platform

  * light-morello
  * light-tasking-morello
  * embedded-morello
  * light-morello-semihosting
  * light-tasking-semihosting
  * embedded-morello-semihosting

The regular Morello runtimes are configured to use UART0 for Ada.Text_IO while
the semihosting runtimes (the runtimes that end with "-semihosting") use
semihosting instead. Either runtime can be used with the Arm Morello
Development Platform depending on your Text_IO needs, while only the
semihosting runtimes can be used with GNATemulator.


Getting Started
---------------

To use the Morello runtimes, configure your project to use the `morello-elf`
toolchain and your desired runtime. This can be done through the GNAT Studio
Project Properities page or by adding the following to your GPR file:

   for Target use "morello-elf";
   for Runtime ("Ada") use "<your runtime choice>";

After building your application you can run it either in GNATemulator or
on the Arm Morello Development Platform.

GNATemulator
~~~~~~~~~~~~

Applications built with the Morello semihosting GNAT runtimes can be run in
GNATemulator through GNAT Studio or from the command line with:

   morello-elf-gnatemu <executable>

Arm Morello Development Platform
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Bare-metal applications can be run on the Arm Morello Development Platform as
a BL33 image running at EL2. The BL33 image is booted by the Trusted Firmware-A
(TF-A) bootloader on the Morello Development Platform and is created using the
Morello toolchain hosted at https://git.morello-project.org/morello

Generating the Application Processor Image
""""""""""""""""""""""""""""""""""""""""""

The following instructions describe the steps to produce the application
processor (AP) image using the Morello toolchain. These instructions are
derived from the Morello tooclhain documentation which can be found at:
https://git.morello-project.org/morello/docs/-/tree/morello/release-1.5?ref_type=heads

First, the host prerequisites for the Morello toolchain must be met. Refer to
Section 2 in the following link for the list of prerequisites:
https://git.morello-project.org/morello/docs/-/blob/morello/release-1.5/user-guide.rst#id6

The Morello LLVM toolchain is also required to build the AP image. This can be
obtained by cloning the morello/baremetal-release-1.5 branch from the
Morello project's llvm-project-releases repository at:
https://git.morello-project.org/morello/llvm-project-releases/-/tree/morello/baremetal-release-1.5?ref_type=heads

   git clone https://git.morello-project.org/morello/llvm-project-releases.git
   cd llvm-project-releases
   git checkout morello/baremetal-release-1.5

Once the prerequisites are met, a Morello workspace can be created and synced
to obtain the sources necessary to build the AP image:

   mkdir workspace
   cd workspace
   repo init \
     -u https://git.morello-project.org/morello/manifest.git \
     -b morello/release-1.5 \
     -g bsp
   repo sync

The next step is to convert the executable output by GNAT into binary format:

   morello-elf-objcopy -Obinary <executable> <executable>.bin

where `<executable>` is the path to your executable that was built by GNAT.

The AP image can now be produced using the Morello toolchain by running the
following commands in your <morello_workspace>:

   make -C "bsp/arm-tf" \
     PLAT=morello TARGET_PLATFORM=soc ENABLE_MORELLO_CAP=1 \
     CC="<llvm_project_release>/bin/clang" clean

   MBEDTLS_DIR="<morello_workspace>/bsp/deps/mbedtls" \
     CROSS_COMPILE="<morello_workspace>/tools/clang/bin/llvm-" \
     make -C "bsp/arm-tf" \
     CC="<llvm_project_release>/bin/clang" \
     LD="<llvm_project_release>/bin/ld.lld" \
     PLAT=morello ARCH=aarch64 TARGET_PLATFORM=soc ENABLE_MORELLO_CAP=1 \
     E=0 TRUSTED_BOARD_BOOT=1 GENERATE_COT=1 ARM_ROTPK_LOCATION="devel_rsa" \
     ROT_KEY="plat/arm/board/common/rotpk/arm_rotprivk_rsa.pem" \
     BL33="<executable>.bin" \
     OPENSSL_DIR="<morello_workspace>/output/soc/intermediates/host_openssl/install" \
     all fip

where:
* `<morello_workspace>` is the path to the Morello workspace.
* `<llvm_project_release>` is the path to the llvm-project-release repository
  that was cloned.
* `<executable>.bin` is the path to the binary executable that was output by
  `morello-elf-objcopy`.

The AP image file (`fip.bin`) will be output at
`<morello_workspace>/bsp/arm-tf/build/morello/release/fip.bin`

Loading the AP Image onto the Arm Morello Development Platform
""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

To load the AP image (`fip.bin`) onto the Arm Morello Development Platform's
microSD card:

#.  Connect the power cable to the Arm Morello Development Platform
#.  Connect a USB cable from your workstation to the DBG USB port on the back
    panel of the Arm Morello Development Platform.
#.  Turn on the Arm Morello Development Platform. After a short delay the board
    should power on and the microSD card should appear as a USB mass storage
    device.
#.  Open a file browser and navigate to the SOFTWARE directory on the mounted
    microSD card.
#.  Replace the fip.bin file with the fip.bin that was created in the previous
    section.
#.  Eject the microSD card's USB mass storage device to flush any pending writes.
#.  Reboot the Arm Morello Development Platform.

Resources used by the runtime
-----------------------------

- The GIC600 interrupt controller for interrupt support;
- Armv8-A Generic Timer
- UART0 or Semihosting for Ada.Text_IO depending on the runtime.

See the respective sections below for further details on each resource used by
the GNAT runtime.

System Clocks
-------------

The Morello GNAT runtimes do not configure the processor clocks as they are
configured by the System Control Processor on boot. Refer to the Arm Morello
System Development Platform Technical Reference Manual for more information
on clock configuration.

The Morello runtimes do need to know the clock speed of the Processor Clock
and Global Timestamp Timer. If you modify either clock speed from their default
(Processor Clock: 2.5 GHz; Global Timestamp Timer: 62.5 MHz), please update
``s-bbpara.ads`` and rebuild the runtime.


Startup Code
------------

The Morello runtimes provide low-level startup code in ``start.S``
that contains the entry point of the application to be called from your
bootloader and performs the low-level runtime initialization required before
high-level Ada code is called. The startup code performs the following
operations:

 * initialization of core registers;
 * Enabling of the FPU;
 * Clearing the BSS section;
 * Loading of the DATA section to RAM if required;
 * Configuration of the MMU.

Outside of the startup code, the runtime will also configure the CPU's
Clocks and GIC. All other SoC initialization and configuration needs to be
carried out by the Secondary Bootloader (SBL) prior to passing
control over to the application. The SBL is also required to load the
application into memory if required. Any peripherals the application may use
should be configured by the SBL or the application directly prior to their use.

The configuration of the MMU is performed by the System.MMU package
(``smmu.adb``). By default, the MMU configured to allow access to the memory
regisons defined in the linker script. The default MMU configuration can be
replaced by providing your own implementation of

   procedure Initialize with
      Export,
      Convention     => C,
      External_Name  => "__initialize_mmu",
      Linker_Section => ".boot";


In limited circumstances, `start.S` may be replaced with your own code that
performs the above requirement and directly calls `main`, but please contact
AdaCore if you need to modify the FPU settings as doing so may affect the
conformance of the runtime to the Ada Standard.


Memory
------

The application memory is broken down into two primary memory regions:

 * Code, read-only data and the initial read-write data ("Code Region")
 * Data and bss (zeroed data) sections ("Data Region")

A set of default linker scripts are provided with the runtimes locate the Code
and Data regions into RAM. These linker scripts can be found in the `ld`
directory and consist of the following:

 * ``ram.ld``: defines the layout of the Arm Morello Development Platform and
   maps the memory regions defined above to the platform's RAM. Currently the
   linker script only provides a maps for the platform's RAM.

 * ``common.ld``: defines the application entry point and sections. It uses the
   memory regions defined in `ram.ld` to allow this script to be used in
   different scenarios without modification.

While you can modify these scripts directly, it's recommended to copy the
scripts you need to modify to your project folder and modify them there. This
allows you to preserve your scripts between runtime updates and is required if
you will be using the runtime to run applications on different cores (as each
application will need to be mapped to different memory locations).

To use your own linker scripts, specify the main linker script via the `-T`
linker switch and use the `-XLOADER=USER` switch when building your application
with GPRbuild.

When relocating the primary memory regions, please keep in mind the following
guidance for each region.

Code Region
~~~~~~~~~~~

The Code Region contains the application code, read-only data and the initial
state of the data section. This region can be located in RAM or read-only
memory like FLASH. If located in RAM, it is the bootloader's responsibility to
load the Code Region to memory.

Data Region
~~~~~~~~~~~

The Data Region contains the data and bss sections. This region needs to be
located in RAM. During runtime startup the runtime will zero the bss section
and copy the initial state of the data section from the Code Region if the two
regions are not located together. There is no need for the bootloader to load
the Data Region to RAM if the Code Region is located in ROM.

Caches
~~~~~~

The runtime enables the data and instruction cache during initialization.


Interrupts
----------

External Interrupts
~~~~~~~~~~~~~~~~~~~

The Morello GNAT runtimes support connecting IRQ interrupts generated by
the processor's GIC600 to protected procedure handlers as documented in the
Ada Reference Manual C.3.1. The list of interrupt names can be found in the
package Ada.Interrupts.Names (`gnarl/a-intnam.ads`). The runtimes support
nested priorities with 16 interrupt priorities levels mapping to Ada Priorities
241-255.


Power Management
----------------

The runtime will place the CPU into standby mode if there are no tasks eligible
to run.

Text_IO
-------

The runtime provides a minimal version of the Ada.Text_IO package supporting
character- and string-based input and output routines for basic I/O needs. It
is recommended to implement your own I/O packages based around your I/O
channel of choice.

The bodies of the Ada.Text_IO routines call through to a device-specific I/O
package named System.Text_IO. See the package body in the file `s-textio.adb`
in the gnat directory for more details.

System.Text_IO on the standard Morello runtimes uses UART0. UART0 is configured
for 115200 baud with 8 data bits, one stop bit, and no parity. System.Text_IO
on the semihosting Morello runtimes use Arm semihosting to print output using
the debugger semihosting capabilities.
